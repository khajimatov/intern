<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XMLHttpsRequest</title>
    <link rel="stylesheet" href="main.css">
</head>

<body>
    <div class="wrapper">
        <h1>Магазин кроссовок</h1>
        <p>Количество заказов: <span id="ordCount">0</span></p>
        <h3 id="listTitle" style="display:none;"></h3>
        <div class="section1">
            <ol id="list"></ol>
        </div>
        <button id="renderItems" onclick="renderItems()">Вывести список заказов</button>
    </div>
</body>

<script>
    function fetchData(method, URL, body = null) {

        return new Promise((res, rej) => {
            let xhr = new XMLHttpRequest();
            xhr.open(method, URL)
            if (method === 'GET') {
                xhr.responseType = 'json'
                xhr.send()
            } else {
                xhr.setRequestHeader("Accept", "application/json");
                xhr.setRequestHeader("Content-Type", "application/json");
                xhr.responseType = 'json'
                xhr.send(body)
            }

            xhr.onload = function () {
                xhr.status != 200 && rej(`Не удалось достучиться до сервера, ошибка ${xhr.status}: ${xhr.statusText}`)
                res(xhr.response)
            };
        })

    }
    async function renderItems() {

        document.getElementById('renderItems').textContent = "Загружаю..."
        const response = await fetchData('GET', 'https://6333d285433198e79dc9c3fd.mockapi.io/orders').then(res => res)

        const renderButton = document.querySelector('#renderItems');
        renderButton.textContent = 'Обновить список заказов';

        document.getElementById('ordCount').innerText = response.length;

        const h3 = document.getElementById('listTitle')
        h3.style.display = "";
        h3.innerText = response.length > 0 ? "Список заказов:" : "Заказов нет :("

        const elems = response.map(element => `<li value="${element.id}"><span id="listText">${element.title}</span><div class="container" style="display: none;"><button id="buttonDelete" title="Удалить" onclick="deleteItem()">X</button><button id="buttonAdd" title="Добавить" onclick="addItem()">+</button><button id="buttonEdit" title="Редактировать" onclick="editItem()">~</button></div></li>`);
        document.getElementById('list').innerHTML = elems.join('');

    }

    function addItem() {


        const ol = document.querySelector("#list");
        const inputBox = document.createElement('input');
        const buttonAddItem = document.createElement('button');

        buttonAddItem.textContent = "Добавить";
        ol.appendChild(inputBox)
        inputBox.after(buttonAddItem)


        buttonAddItem.onclick = () => {
            let obj = { "title": inputBox.value };
            let json = JSON.stringify(obj)
            fetchData('POST', 'https://6333d285433198e79dc9c3fd.mockapi.io/orders', json).then(res => res)
            let node = document.createElement('li');
            node.appendChild(document.createTextNode(inputBox.value));
            document.getElementById('list').appendChild(node);
            buttonAddItem.style.display = "none";
            inputBox.style.display = "none";
            renderItems();
        }

    }
    function editItem(liId, i) {

        const id = i;
        const lItems = document.getElementsByTagName("li");
        const container = lItems[i].querySelector('.container');
        const listText = lItems[i].querySelector('#listText');
        const inputBox = document.createElement('input');
        const buttonEditTitle = document.createElement('button');
        buttonEditTitle.textContent = "Изменить";

        container.style.display = "none";
        inputBox.value = listText.textContent;
        container.before(inputBox);
        inputBox.after(buttonEditTitle);
        listText.textContent = "";

        buttonEditTitle.onclick = () => {

            liId.toString();
            let obj = { "title": inputBox.value, "id": liId };
            let json = JSON.stringify(obj)
            fetchData('PUT', `https://6333d285433198e79dc9c3fd.mockapi.io/orders/${obj.id}`, json).then(res => res).catch(rej => alert(rej))

            listText.textContent = inputBox.value;
            buttonEditTitle.style.display = "none";
            inputBox.style.display = "none";
        };
    }

    async function deleteItem(liId) {

        liId.toString();
        let obj = { "id": liId };
        let json = JSON.stringify(obj)
        let lItems = document.getElementsByTagName("li");
        for (let i = 0; i < lItems.length; i++) {
            lItems[i].value === liId && lItems[i].remove()
        }
        await fetchData('DELETE', `https://6333d285433198e79dc9c3fd.mockapi.io/orders/${obj.id}`, json).then(res => res).catch(rej => alert(rej))
        renderItems();

    }
    document.getElementById('list').addEventListener('mouseover', (e) => {
        if (e.target && e.target.matches('li')) {
            e.target.querySelector('.container').style.display = "inline";
            e.target.querySelecjtor('.container').querySelector('#buttonDelete').onclick = () => { deleteItem(parseInt(e.target.value)) }
        }
    })

    // Проверяет наличие наведения курсора на <li>
    setInterval(() => {

        lis = document.querySelectorAll('li')
        for (let i = 0; i < lis.length; i++) {
            if (lis[i].matches(':hover')) {
                lis[i].querySelector('.container').style.display = "inline";
                lis[i].querySelector('.container').querySelector('#buttonDelete').onclick = () => { deleteItem(parseInt(lis[i].value), i) }
                lis[i].querySelector('.container').querySelector('#buttonEdit').onclick = () => { editItem(parseInt(lis[i].value), i) }
                lis[i].querySelector('.container').querySelector('#buttonAdd').onclick = () => { addItem() }
            } else {
                lis[i].querySelector('.container').style.display = "none";
            }
        }

    }, 0)
</script>

</html>